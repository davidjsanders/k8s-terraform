---
- hosts: all

  tasks:
    - name: Update packages
      apt:
        upgrade: full
        force_apt_get: yes
        update_cache: yes
        dpkg_options: 'force-confold,force-confdef'
    - name: Set TimeZone to Toronto
      timezone:
        name: America/Toronto
    - name: Disable swap
      shell: |
        swapoff -a
    - name: Disable SWAP in fstab
      replace:
        path: /etc/fstab
        regexp: '^(.+?\sswap\s+sw\s+.*)$'
        replace: '# \1'

- hosts: master
  become: true

  tasks:
    - name: Install packages
      apt:
        name: "{{ packages }}"
        force_apt_get: yes
        update_cache: no
        dpkg_options: 'force-confold,force-confdef'
      vars:
        packages:
        - nfs-kernel-server
        - nfs-common
        - jq
    - name: Get UUID for datadisk
      shell: |
        blkid | grep /dev/sdc1 | awk '{print $2}' | sed -e 's/UUID="\(.*\)\"/\1/'
      register: uuid
    - name: Show UUID
      debug:
        msg: "UUID is {{ uuid.stdout }}"
    - name: Make mount point
      file:
        path: /datadrive
        state: directory
        mode: '0777'
    - name: Configure datadrive in fstab
      mount: 
        path: /datadrive
        src: UUID={{ uuid.stdout }}
        fstype: ext4
        opts: defaults,nofail
        state: mounted
    - name: Make NFS share
      file:
        path: /datadrive/export
        state: directory
        mode: '0777'
    - name: Make NFS share
      file:
        path: /datadrive/export
        state: directory
        mode: '0777'
    - name: Add entry to NFS exports for k8s-master
      lineinfile:
        path: /etc/exports
        line: /datadrive/export {{ item }}(rw,async,no_root_squash,insecure,fsid=0,crossmnt,no_subtree_check)
      with_items:
        - "{{ hostvars['k8s-master']['ansible_facts']['eth0']['ipv4']['address'] }}"
        - "{{ hostvars['k8s-jumpbox']['ansible_facts']['eth0']['ipv4']['address'] }}"
        - "{{ hostvars['k8s-worker-1']['ansible_facts']['eth0']['ipv4']['address'] }}"
        - "{{ hostvars['k8s-worker-2']['ansible_facts']['eth0']['ipv4']['address'] }}"
    - name: Restart NFS server
      service:
        name: nfs-kernel-server
        state: restarted